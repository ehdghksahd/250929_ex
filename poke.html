<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PokeSearch</title>
    <meta property="og:title" content="Poke" />
    <meta property="og:description" content="í¬ì¼“ëª¬ ë„ê°" />
    <meta property="og:image" content="./250929_ex/ball.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      /* í¬ì¼“ëª¬ ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • */
      .poke-img {
        width: 96px; /* ê¸°ë³¸ í¬ì¼“ëª¬ ìŠ¤í”„ë¼ì´íŠ¸ í¬ê¸° */
        height: 96px;
      }
      /* í¬ì¼“ëª¬ ë°•ìŠ¤ ì¤‘ì•™ ì •ë ¬ ë° ê°„ê²© ì¡°ì • */
      #pokeBox {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #dee2e6; /* ì—°í•œ í…Œë‘ë¦¬ */
        border-radius: 8px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="mb-4 text-center">í¬ì¼“ëª¬ ê²€ìƒ‰ê¸° ğŸ”</h1>

      <section class="d-flex align-items-center justify-content-center mb-4">
        <label for="pokeId" class="form-label me-2 mb-0">í¬ì¼“ëª¬ ID :</label>
        <input
          id="pokeId"
          type="number"
          min="1"
          class="form-control w-25 me-2"
          placeholder="ID ì…ë ¥ (ì˜ˆ: 1)"
        />
        <button id="pokeBtn" class="btn btn-primary">ê²€ìƒ‰</button>
      </section>

      <section id="pokeBox" class="shadow-sm"></section>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      // 1. APIì—ì„œ ë°ì´í„° í˜¸ì¶œí•˜ê¸°
      async function getPokemon(id) {
        if (!id) return;

        console.log(`${id}ë²ˆ í¬ì¼“ëª¬ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤`);
        const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
        if (!response.ok) {
          alert("í•´ë‹¹ IDì˜ í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          document.querySelector(
            "#pokeBox"
          ).innerHTML = `<p class="text-danger">í¬ì¼“ëª¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p>`;
          return;
        }
        const data = await response.json();

        const response2 = await fetch(
          `https://pokeapi.co/api/v2/pokemon-species/${id}`
        );
        const data2 = await response2.json();

        // í•œê¸€ ì´ë¦„
        const koName = data2.names.filter((v) => v.language.name === "ko")[0]
          .name;

        // ì§„í™” ì²´ì¸ ë°ì´í„° í˜¸ì¶œ
        const evId = data2.evolution_chain.url;
        const evoResponse = await fetch(evId);
        const evoData = await evoResponse.json();

        // ë‹¤ìŒ ì§„í™”ì²´ ID ê³„ì‚°
        const nextEvoId = getNextEvolutionId(data.name, evoData.chain);

        const poke = {
          engName: data.name,
          koName,
          frontShape: data.sprites.front_default,
          backShape: data.sprites.back_default,
          nextEvoId: nextEvoId, // ë‹¤ìŒ ì§„í™”ì²´ì˜ ID ì €ì¥
          sound: data.cries.latest,
        };
        localStorage.setItem("recent", JSON.stringify(poke));
        renderPoke(poke);
      }

      // **ìƒˆë¡œìš´ í•¨ìˆ˜: ì§„í™” ì²´ì¸ì—ì„œ ë‹¤ìŒ í¬ì¼“ëª¬ ID ì°¾ê¸°**
      function getNextEvolutionId(currentName, chain) {
        // í˜„ì¬ í¬ì¼“ëª¬ì´ ê¸°ë³¸ ì§„í™”í˜•ì¸ ê²½ìš°
        if (chain.species.name === currentName) {
          if (chain.evolves_to.length > 0) {
            const nextSpeciesUrl = chain.evolves_to[0].species.url;
            return extractIdFromUrl(nextSpeciesUrl);
          }
          return null; // ì§„í™”ì²´ê°€ ì—†ìŒ
        }

        // í˜„ì¬ í¬ì¼“ëª¬ì´ ê¸°ë³¸ ì§„í™”í˜•ì´ ì•„ë‹Œ ê²½ìš°
        for (const evolution of chain.evolves_to) {
          if (evolution.species.name === currentName) {
            if (evolution.evolves_to.length > 0) {
              const nextSpeciesUrl = evolution.evolves_to[0].species.url;
              return extractIdFromUrl(nextSpeciesUrl);
            }
            return null; // ë‹¤ìŒ ì§„í™”ì²´ê°€ ì—†ìŒ
          }
          // ì¬ê·€ì ìœ¼ë¡œ ë” ê¹Šì€ ì§„í™” ë‹¨ê³„ë¥¼ íƒìƒ‰
          const nestedResult = getNextEvolutionId(currentName, evolution);
          if (nestedResult) return nestedResult;
        }

        return null; // ì°¾ì§€ ëª»í•¨
      }

      // **ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: URLì—ì„œ ID ì¶”ì¶œ**
      function extractIdFromUrl(url) {
        const parts = url.split("/");
        return parts[parts.length - 2];
      }

      // **ìƒˆë¡œìš´ í•¨ìˆ˜: ì§„í™” ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬**
      function handleEvolutionClick(nextEvoId) {
        if (nextEvoId) {
          // ë‹¤ìŒ ì§„í™”ì²´ì˜ IDë¡œ getPokemon í•¨ìˆ˜ í˜¸ì¶œ
          pokeId.value = nextEvoId;
          getPokemon(nextEvoId);
        } else {
          alert("ë” ì´ìƒ ì§„í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      }

      // 2. input í†µí•´ ë²ˆí˜¸ ë°”ê¿”ë³´ê¸°
      const pokeBtn = document.querySelector("#pokeBtn");
      const pokeId = document.querySelector("#pokeId");
      pokeBtn.addEventListener("click", () => getPokemon(pokeId.value));

      // 3. ë°ì´í„° í™”ë©´ì— ê·¸ë¦¬ê¸°
      function renderPoke({
        engName,
        koName,
        frontShape,
        backShape,
        sound,
        nextEvoId,
      }) {
        const pokeBox = document.querySelector("#pokeBox");
        // Bootstrap í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë””ìì¸ ì ìš©
        const buttonDisabled = nextEvoId ? "" : "disabled";
        const buttonText = nextEvoId ? "ë‹¤ìŒ ì§„í™”ì²´ â¡ï¸" : "ìµœì¢… ì§„í™” ğŸŒŸ";

        pokeBox.innerHTML = `
            <h4 class="text-primary mb-1">${koName}</h4> <h5 class="text-muted mb-3">(${engName})</h5> <div class="d-flex justify-content-center mb-3">
                <img src="${frontShape}" class="poke-img me-3 border rounded" alt="${koName} ì•ëª¨ìŠµ">
                <img src="${backShape}" class="poke-img border rounded" alt="${koName} ë’·ëª¨ìŠµ">
            </div>
            <button id="evolutionBtn" class="btn btn-success mb-3" ${buttonDisabled}>${buttonText}</button></br>
            <audio src="${sound}" controls class="w-100"></audio> `;

        // ë²„íŠ¼ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if (nextEvoId) {
          const evolutionBtn = document.querySelector("#evolutionBtn");
          evolutionBtn.addEventListener("click", () =>
            handleEvolutionClick(nextEvoId)
          );
        }
      }

      // 4. ì§ì „ ê²€ìƒ‰ ë°ì´í„°ë¥¼ Storage. ìë™ ë¡œë”©.
      document.addEventListener("DOMContentLoaded", () => {
        const rawRecentPoke = localStorage.getItem("recent");
        if (!rawRecentPoke) return;
        const recentPoke = JSON.parse(rawRecentPoke);
        // ì €ì¥ëœ í¬ì¼“ëª¬ IDë¥¼ inputì— ì±„ì›Œ ë„£ê¸° (ì„ íƒ ì‚¬í•­)
        // IDëŠ” getPokemonì˜ data.idì—ì„œ ê°€ì ¸ì˜¤ì§€ ì•Šì•„ ì €ì¥ë˜ì–´ ìˆì§€ ì•Šìœ¼ë¯€ë¡œ, ì´ ë¶€ë¶„ì„ ìƒëµí•©ë‹ˆë‹¤.
        renderPoke(recentPoke);
      });
    </script>
  </body>
</html>
